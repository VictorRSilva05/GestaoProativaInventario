@model IEnumerable<GestaoProativaInventario.Models.Previsao>

@{
    ViewData["Title"] = "Previsão de Demanda";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Previsão de Demanda</h1>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                Gerar Nova Previsão e Visualizar Gráfico
            </div>
            <div class="card-body">
                <form asp-action="GerarPrevisao" method="post" class="row g-3 align-items-end mb-4">
                    <div class="col-md-4">
                        <label for="produtoId" class="form-label">Produto:</label>
                        <select name="produtoId" id="produtoId" class="form-select" asp-items="ViewBag.ProdutoId" required>
                            <option value="">Selecione um Produto</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="periodoObservacao" class="form-label">Período de Observação (dias):</label>
                        <input type="number" name="periodoObservacao" id="periodoObservacao" class="form-control" value="90" min="1" required>
                    </div>
                    <div class="col-md-3">
                        <label for="intervaloPrevisao" class="form-label">Intervalo de Previsão (dias):</label>
                        <input type="number" name="intervaloPrevisao" id="intervaloPrevisao" class="form-control" value="30" min="1" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Gerar Previsão</button>
                    </div>
                </form>

                <div id="demand_forecast_chart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
            var productId = $("#produtoId").val();
            if (!productId) {
                document.getElementById('demand_forecast_chart').innerHTML = '<div class="alert alert-info">Selecione um produto e gere a previsão para visualizar o gráfico.</div>';
                return;
            }

            // --- INÍCIO DA MODIFICAÇÃO (Tema Escuro) ---
            var chartTextStyle = { color: '#F0F0F0' }; // Texto principal
            var axisTextStyle = { color: '#A0A0B0' }; // Texto dos eixos

            var darkThemeOptions = {
                backgroundColor: 'transparent', // Fundo do gráfico
                legend: { textStyle: chartTextStyle, position: 'bottom' },
                titleTextStyle: chartTextStyle,
                hAxis: { 
                    title: 'Data', 
                    format: 'yyyy-MM-dd',
                    textStyle: axisTextStyle, 
                    titleTextStyle: axisTextStyle,
                    gridlines: { color: '#2A2A3A' } // Cor das linhas de grade
                },
                vAxis: { 
                    title: 'Quantidade',
                    textStyle: axisTextStyle, 
                    titleTextStyle: axisTextStyle,
                    gridlines: { color: '#2A2A3A' } // Cor das linhas de grade
                }
            };
            // --- FIM DA MODIFICAÇÃO ---

            $.getJSON('/Previsao/GetDemandForecastChartData?productId=' + productId, function (jsonData) {
                var data = google.visualization.arrayToDataTable(jsonData);

                var options = {
                    title: 'Vendas Reais vs. Previsão de Demanda',
                    curveType: 'function',
                    series: {
                        0: { color: '#3333FF' }, // Vendas Reais (Azul Predistock)
                        1: { color: '#FFAB00', lineDashStyle: [4, 4] } // Previsão (Amarelo)
                    },
                    // Aplica o tema escuro
                    ...darkThemeOptions
                };

                var chart = new google.visualization.LineChart(document.getElementById('demand_forecast_chart'));
                chart.draw(data, options);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                document.getElementById('demand_forecast_chart').innerHTML = '<div class="alert alert-warning">Não foi possível carregar os dados do gráfico. Verifique se há previsões geradas para o produto selecionado.</div>';
            });
        }

        // Redesenha o gráfico quando o produto selecionado muda
        $("#produtoId").change(function () {
            drawChart();
        });
    </script>
}